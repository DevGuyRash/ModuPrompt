name: CI

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  rust:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Detect Rust workspace
        id: cargo
        shell: bash
        run: |
          set -euo pipefail
          if [ -f Cargo.toml ]; then
            echo "present=true" >> "$GITHUB_OUTPUT"
            echo "dir=." >> "$GITHUB_OUTPUT"
            exit 0
          fi

          mapfile -t candidates < <(find . -maxdepth 4 -name Cargo.toml -type f | sort)
          if [ ${#candidates[@]} -eq 0 ]; then
            echo "present=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          workspace=""
          for file in "${candidates[@]}"; do
            if grep -q "^[[:space:]]*\\[workspace\\]" "$file"; then
              workspace="$file"
              break
            fi
          done

          if [ -z "$workspace" ]; then
            workspace="${candidates[0]}"
          fi

          echo "present=true" >> "$GITHUB_OUTPUT"
          echo "dir=$(dirname "$workspace")" >> "$GITHUB_OUTPUT"
      - name: Install Rust toolchain
        if: ${{ steps.cargo.outputs.present == 'true' }}
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - name: Rust fmt
        if: ${{ steps.cargo.outputs.present == 'true' }}
        working-directory: ${{ steps.cargo.outputs.dir }}
        run: cargo fmt --all -- --check
      - name: Rust clippy
        if: ${{ steps.cargo.outputs.present == 'true' }}
        working-directory: ${{ steps.cargo.outputs.dir }}
        run: cargo clippy --workspace --all-targets --all-features --locked -- -D warnings
      - name: Cargo deny
        if: ${{ steps.cargo.outputs.present == 'true' }}
        working-directory: ${{ steps.cargo.outputs.dir }}
        run: |
          cargo install cargo-deny --locked
          mkdir -p target
          cargo metadata --format-version=1 --all-features > target/deny-metadata.json
          cargo deny check --metadata-path target/deny-metadata.json
      - name: Rust build (all targets)
        if: ${{ steps.cargo.outputs.present == 'true' }}
        working-directory: ${{ steps.cargo.outputs.dir }}
        run: cargo test --workspace --all-features --all-targets --locked --no-run
      - name: Rust tests
        if: ${{ steps.cargo.outputs.present == 'true' }}
        working-directory: ${{ steps.cargo.outputs.dir }}
        run: cargo test --workspace --all-features --locked

  docs:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Docs checks
        run: python scripts/check_docs.py
